---
title: "length of stay in hospital parameterisation"
author: "Rob Challen"
date: "14 April 2020"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
devtools::load_all("~/Git/uk-covid-datatools/")
devtools::load_all("~/Git/standard-print-output/")
source("~/Git/uk-covid-datatools/data-raw/rawDataFunctions.R")
library(survival)
library(patchwork)
```

```{r}
paths=list(
  chess="~/S3/encrypted/15Apr/CHESS COVID19 CaseReport 20200415.csv",
  lineList="~/S3/encrypted/15Apr/Anonymised Line List 20200415.xlsx",
  ff100="~/S3/encrypted/15Apr/Anonymised Line List 20200415.xlsx",
  chessSummary="~/S3/encrypted/15Apr/CHESS Aggregate Report 20200415.csv",
  sitrep="~/S3/encrypted/8Apr/Covid sitrep report incl CIC 20200408 FINAL.xlsx",
  bristol="~/S3/encrypted/AVONCAP_DATA_2020-04-18_1944.csv"
)

ggplot2::theme_set(standardPrintOutput::defaultFigureLayout())
CHESSClean = getCHESS(paths$chess) %>% cleanseCHESSData("2020-04-15")
```



## Survival model - Admission to ITU Admission to Death or

```{r}

# admissionToDischargeOrDeathUnadj = CHESSClean %>% filter(age>10) %>%
#   mutate(status = ifelse(!is.na(finaloutcome),1,0), time)
# meanKnownOutcome = mean(admissionToDischargeOrDeathUnadj$status)
# dataQualityCheck = admissionToDischargeOrDeathUnadj %>% group_by(trustcode, status) %>% summarise(n=n(), sumTime = sum(time)) %>% 
#   pivot_wider(names_from = status, values_from = c("n", "sumTime")) %>% 
#   mutate(
#     N=n_0+n_1,
#     knownOutcome = n_1/(N),
#     meanTime=(sumTime_0+sumTime_1)/(N)
#   )
# excl2 = dataQualityCheck %>% filter(knownOutcome < (meanKnownOutcome) - sd(dataQualityCheck$knownOutcome))
# CHESSClean = CHESSClean %>% anti_join(excl2, by="trustcode")

admissionToItuAdmission = CHESSClean %>% filter(age>10) %>% generateSurvivalData(
  idVar = caseid,
  startDateVar = hospitaladmissiondate, 
  endDateExpr = if_else(is.na(dateadmittedicu), finaloutcomedate, dateadmittedicu),
  statusExpr = case_when(
    !is.na(dateadmittedicu) ~ 1,
    !is.na(finaloutcomedate) ~ 2,
    TRUE ~ 0),
  ageVar = "age", 
  censoredDateExpr = censorDate,
  statusLabels = c("censored","admitted ITU", "not admitted ITU"),
  ageBreaks = c(-Inf,50,70,80,Inf), 
  ageLabels = c("10-50","50-70","70-80","80+"),
  ageReferenceCat = "10-50"
) %>% select(
     caseid, status, trustcode, finaloutcome, time, ageCat, sex
 )
```

# summarise data

```{r}
summary = bind_rows(
  admissionToItuAdmission %>% mutate(value = status) %>% group_by(value) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(admissionToItuAdmission)*100)) %>% mutate(category="Outcome"),
  
  admissionToItuAdmission %>% group_by(value = sex) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(admissionToItuAdmission)*100)) %>% mutate(category="Gender", value = as.character(value)),
  admissionToItuAdmission %>% group_by(value = ageCat) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(admissionToItuAdmission)*100)) %>% mutate(category="Age", value = as.character(value)) %>% arrange(value),
  
#  tibble(category="Time",value = sprintf("%1.2f days [%1.2f; %1.2f]", mean(admissionToItuAdmission$time), ))
  
  admissionToItuAdmission %>% summarise(N=n()) %>% mutate(category="Total", value = "", `%age`="" )
)

summary %>% group_by(category) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Table1_summary")
```

# fit a survival model

```{r}
fitByAgeCat = survfit(Surv(time,status, type="mstate") ~ age, admissionToItuAdmission %>% rename(age = ageCat))
plot = survminer::ggcompetingrisks(
  fitByAgeCat, pval=TRUE, conf.int = TRUE, palette = "Accent"
)

(plot+standardPrintOutput::defaultFigureLayout()) %>% 
  standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Fig1_CumIncideceByAge")

# summary(admissionToDischargeOrDeath)

survModel1 = coxph(Surv(time, status == "admitted ITU") ~ sex + age, admissionToItuAdmission %>% rename(age=ageCat))
survModel2 = coxph(Surv(time, status, type="mstate") ~ sex + age, (admissionToItuAdmission %>% rename(age=ageCat)), id=caseid)
# survModel %>% gtsummary::tbl_regression(exp = TRUE) 

survminer::ggforest(survModel1) %>% 
  standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Fig2_coxModel")
```

# Parameter fitting

```{r}
censoredAdmissionToItuAdmission = CHESSClean %>% filter(age>15) %>% generateSurvivalData(
    startDateVar = hospitaladmissiondate, 
    endDateExpr = if_else(is.na(dateadmittedicu),finaloutcomedate,dateadmittedicu),
    statusExpr = case_when(
      !is.na(dateadmittedicu) ~ 1,
      !is.na(finaloutcomedate) ~ 2,
      TRUE ~ 0),
    censoredDateExpr = censorDate,
    statusLabels = c("censored","admit ITU","no ITU")
) %>% select(
    age, ageCat, time, status
)
```

```{r}
multistateAdmissionToItuAdmission = CHESSClean %>% filter(age>15) %>% group_by(caseid, sex) %>% generateMultistateSurvivalData(
  idVar = caseid,
  transMatrix = transitionMatrix(
    admitted=`ITU admission`,
    admitted=`discharge death`
    #`ITU admission`=`discharge death`
  ),
  ageBreaks = c(-Inf,50,70,80,Inf), 
  ageLabels = c("10-50","50-70","70-80","80+"),
  censoringDateExpr = censorDate,
  startDateCol = "admitted",
  admitted = hospitaladmissiondate, 
  `ITU admission` = dateadmittedicu,
  `discharge death` = finaloutcomedate
)
```

# Parameter fitting goodness of fit for simgle age group

```{r}
# models = c("weibull","gamma","lnorm")
#   
# subGroup = censoredAdmissionToItuAdmission %>% filter(ageCat=="40-44") %>% select(left,right) %>% as.data.frame()
# dists = suppressWarnings(lapply(models, function(m) fitdistrplus::fitdistcens(subGroup, m, lower = c(0, 0)))) 
# p1 = fitdistrplus::qqcompcens(dists, plotstyle = "ggplot") +standardPrintOutput::narrowAndTall()
# p2 = fitdistrplus::ppcompcens(dists, plotstyle = "ggplot") +standardPrintOutput::narrowAndTall()
# (p1 + p2 + patchwork::plot_layout(ncol=2)) %>% standardPrintOutput::saveQuarterPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Fig3_fitDistributions")
```

# fit all models

```{r}

crweib <- flexsurv::flexsurvreg(Surv(time, status) ~ ageCat + trans + shape(trans), data = multistateAdmissionToItuAdmission, dist = "weibull")
crlnorm <- flexsurv::flexsurvreg(Surv(time, status) ~ ageCat + trans + sdlog(trans), data = multistateAdmissionToItuAdmission, dist = "lnorm")
crlnorm <- flexsurv::flexsurvreg(Surv(Tstart, Tstop, status) ~ ageCat + trans + sdlog(trans), data = multistateAdmissionToItuAdmission, dist = "lnorm")

plot(crweib)
plot(crlnorm)

# https://www.rdocumentation.org/packages/flexsurv/versions/1.1.1/topics/msfit.flexsurvreg


survModel = coxph(Surv(time, status, type = "mstate") ~ sex + ageCat, multistateAdmissionToItuAdmission, id=id)
survminer::ggforest(survModel)

#crcox = coxph(Surv(time, status) ~ strata(trans), data = multistateAdmissionToItuAdmission)
# out = censoredAdmissionToItuAdmission %>% fitModelsByAge(c("lnorm"))
# 
# out %>% mutate(value = sprintf("%1.4f [%1.4f; %1.4f]", value, low_ci, high_ci)) %>% select(ageCat,n,model,aic,bic,loglik,param, value) %>% 
#   group_by(ageCat,n,model,aic,bic,loglik) %>% standardPrintOutput::saveTableLandscape("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/SuppTable1_fullBreakdownFittedModels")
```

# select log normal models

```{r}
out %>% filter(model=="lnorm") %>% ungroup() %>% mutate(value = sprintf("%1.4f [%1.4f; %1.4f]", value, low_ci, high_ci)) %>%
  select(-low_ci,-high_ci) %>% 
  pivot_wider(names_from = param, values_from = value) %>% select(
  -model,-bic,-aic,age=ageCat, N = n, `log(likelihood)`=loglik, `log(mean) [95% CrI]` = meanlog, `log(sd) [95% CrI]` = sdlog
  ) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Table2_logNormalParameterisation")
```

# generate log normal curves

```{r}
survSurf = out %>% createSurvivalSurfaces(days=10)
surf = plotSurvivalSurface(survSurf)
surf %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Fig4_losDensity")
write.csv(
  survSurf %>% ungroup() %>% mutate(surv = 1-cdf) %>% select(ageCat,days,surv),
  file="~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/admission-to-itu-admission.csv")        
```

# incidence surves more important for other transitions

```{r}
surf2 = plotIncidenceSurface(survSurf)
surf2
```

# validate against Bristol data

Do a set of Kolmogorov-Smirnov tests on different combinations of parameters and log normal distributions

```{r}
bri = getBristolData(paths$bristol)
bri = bri %>% bristolSurvivalSubset() 
bri2 = bri %>% generateSurvivalData(
    admission_date,
    discharge_date
)

doKSTest = function(d,g,paramNames,params,n) {
  sample = d$time
  params = as.list(params)
  names(params) = paramNames
  params$x = jitter(sample)
  params$y = "plnorm"
  #browser()
  ks = do.call("ks.test",params)
  return(tibble(
    testN = length(sample),
    referenceN = max(n),
    pValue = ks$p.value,
    dStatistic = ks$statistic
  ))
}

gofBri = bri2 %>% filter(status == 1) %>% group_by(ageCat) %>% group_modify(function(d,g,...) {
  reference = out %>% filter(model == "lnorm" & ageCat == g$ageCat)
  out = bind_rows(
    doKSTest(d,g,reference$param, reference$value, reference$n) %>% mutate(estimate = "central"),
    doKSTest(d,g,reference$param, reference$low_ci, reference$n) %>% mutate(estimate = "low credible"),
    doKSTest(d,g,reference$param, reference$high_ci, reference$n) %>% mutate(estimate = "high credible")
  )
})

numbers = gofBri %>% select(ageCat,estimate,test=testN,fit=referenceN) %>% pivot_longer(cols=c("test","fit"),names_to = "source", values_to = "N")

top = ggplot(gofBri, aes(x=ageCat,y=pValue,fill=estimate))+geom_bar(stat="identity", position="dodge", width=0.7, colour="black")+standardPrintOutput::narrowAndTall()+theme(axis.text.x = element_blank(), axis.title.x = element_blank())+ylab("P value")
bottom = ggplot(numbers, aes(x=ageCat,y=source,label=N, colour = source))+geom_text()+guides(colour="none")+theme(panel.grid = element_blank(),axis.title.x = element_blank())+ylab("N")

(top+bottom+patchwork::guide_area()+patchwork::plot_layout(ncol=1, heights = c(9,2,1), guides = "collect")) %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/admission-to-itu-admission/Fig5_validateBristol")
```
