---
title: "length of stay in hospital parameterisation"
author: "Rob Challen"
date: "14 April 2020"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
devtools::load_all("~/Git/uk-covid-datatools/")
devtools::load_all("~/Git/standard-print-output/")
source("~/Git/uk-covid-datatools/data-raw/rawDataFunctions.R")
library(survival)
library(patchwork)

paths=findDatafile()
standardPrintOutput::setDefaults()
```

```{r}

CHESS = getCHESS(paths$chess)
cq = CHESS %>% chessQuality()
# ggplot(cq, aes(x=trustcode, y=records))+geom_bar(stat="identity")+standardPrintOutput::narrowAndTall()
p = ggplot(cq, aes(x=knownOutcomePercent, y=knownAdmittedItuPercent, label=trustcode, colour=updatedRecords/records))+geom_point()+geom_vline(xintercept=0.1)+geom_hline(yintercept=0.5)+scale_color_gradient(low="red",high="green")+
  standardPrintOutput::narrowAndTall()
p2 = ggExtra::ggMarginal(p, type="histogram")
p2 %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/chessDataQuality")

CHESSClean = CHESS %>% chessItuSubset()
```

## Survival model - Admission to outcome

* Excludes hospitals which:
* A) haven;t updated data from > 3 days
* B) Have censored outcomes mode than one sd from the mean.
* N.b. This is over half of the hospitals.

* furthermore some other data quality issues e.g. outcome date before admission date
* multiple admissions: just use first admission

```{r}
ituAdmissionToDischargeOrDeath = CHESSClean %>% filter(age>10) %>% generateSurvivalData(
  idVar = caseid,
  startDateVar = dateadmittedicu, 
  endDateExpr = dateleavingicu, 
  statusExpr = if_else(is.na(dateleavingicu),0,1),
  censoredDateExpr = censorDate,
  ageBreaks = c(-Inf,30,50,70,Inf),
  ageLabels = c("10-30","30-50","50-70","70+"),
  ageReferenceCat = "30-50",
  statusLabels = c("censored","discharged/died")
) %>% select(
  caseid, status, trustcode, finaloutcome, time, ageCat, sex
)
```

# summarise data

```{r}
summary = bind_rows(
  ituAdmissionToDischargeOrDeath %>% group_by(value = finaloutcome) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(ituAdmissionToDischargeOrDeath)*100)) %>% mutate(category="Outcome", value = if_else(is.na(value),"Inpatient",as.character(value))),
  ituAdmissionToDischargeOrDeath %>% group_by(value = sex) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(ituAdmissionToDischargeOrDeath)*100)) %>% mutate(category="Gender", value = as.character(value)),
  ituAdmissionToDischargeOrDeath %>% group_by(value = ageCat) %>% summarise(N=n(), `%age`=sprintf("%1.1f %%",n()/nrow(ituAdmissionToDischargeOrDeath)*100)) %>% mutate(category="Age", value = as.character(value)) %>% arrange(value),
  ituAdmissionToDischargeOrDeath %>% summarise(N=n()) %>% mutate(category="Total", value = "", `%age`="" )
)

summary %>% group_by(category) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Table1_summary")
```

# fit a survival model



```{r}
tmpSurv= ituAdmissionToDischargeOrDeath %>% rename(age = ageCat) %>% mutate(status = as.integer(status)-1)
fitByAgeCat = survfit(Surv(time,status) ~ age, tmpSurv)
plot = survminer::ggsurvplot(
  fitByAgeCat, conf.int = TRUE
)+ylab("P(itu patient)")

(plot$plot+standardPrintOutput::defaultFigureLayout()) %>% 
  standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig1_kaplanMeierByAge")

# summary(admissionToDischargeOrDeath)

survModel = coxph(Surv(time,status) ~ sex + age, tmpSurv)
# survModel %>% gtsummary::tbl_regression(exp = TRUE) 

survminer::ggforest(survModel ) %>% 
  standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig2_coxModel")
```

Interpretation is that a high HR => discharge or death is more likely - i.e. an inpatient admission is likely to be shorter.

# Parameter fitting

Uses different age bands

```{r}
censoredItuAdmissionToDischargeOrDeath = CHESSClean %>% filter(age>15) %>% generateSurvivalData(
  idVar=caseid,
  startDateVar = hospitaladmissiondate, 
  endDateExpr = finaloutcomedate, 
  statusExpr = if_else(is.na(finaloutcome),0,1),
  statusLabels = c("censored","discharged/died")
) %>% select(
  caseid, status, trustcode, finaloutcome, time, ageCat, sex
)
```

# Parameter fitting goodness of fit test for single age group

Look at 40-45 year old men for checking distribution fit visually

```{r}
models = standardModels()
  
subGroup = censoredItuAdmissionToDischargeOrDeath %>% filter(ageCat=="40-44") %>% mutate(
    left=time,
    right=if_else(status=="censored", as.double(NA), time)
  ) %>% select(left,right) %>% as.data.frame()

fitdistrplus::plotdist(censoredItuAdmissionToDischargeOrDeath$time, histo=TRUE, demp=TRUE)
fitdistrplus::descdist(censoredItuAdmissionToDischargeOrDeath$time, discrete=FALSE, boot=500)

dists = suppressWarnings(lapply(models, function(m) fitdistrplus::fitdistcens(subGroup, m$name, lower = c(0, 0), start = m$start))) 
p1 = fitdistrplus::qqcompcens(dists, plotstyle = "ggplot") +standardPrintOutput::narrowAndTall()
p2 = fitdistrplus::ppcompcens(dists, plotstyle = "ggplot") +standardPrintOutput::narrowAndTall()
(p1 + p2 + patchwork::plot_layout(ncol=2)) %>% standardPrintOutput::saveQuarterPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig3_fitDistributions")
```

# fit all models to all age groups

Log norms seem to fit best for all age groups

```{r}
out = censoredItuAdmissionToDischargeOrDeath %>% fitModelsByAge()

out %>% mutate(value = sprintf("%1.4f [%1.4f; %1.4f]", value, low_ci, ifelse(high_ci>100,Inf,high_ci))) %>% select(ageCat,n,model,aic,bic,loglik,param, value) %>% 
  group_by(ageCat,n,model,aic,bic,loglik) %>% standardPrintOutput::saveTableLandscape("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/SuppTable1_fullBreakdownFittedModels")
```

# select gamma models

```{r}
out %>% filter(model=="gamma") %>% ungroup() %>% mutate(value = sprintf("%1.4f [%1.4f; %1.4f]", value, low_ci, ifelse(high_ci>100,Inf,high_ci))) %>%
  select(-low_ci,-high_ci) %>% 
  pivot_wider(names_from = param, values_from = value) %>% select(
  -model,-bic,-aic,age=ageCat, N = n, `log(likelihood)`=loglik, `shape [95% CrI]` = shape, `rate [95% CrI]` = rate
  ) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Table2_logNormalParameterisation")
```

# generate log normal curves for each age group

* A - "best fit" estimate
* B - low CrI estimate
* C - high CrI estimate

```{r}
survSurf = out %>% createSurvivalSurfaces(days=40)
surf = plotSurvivalSurface(survSurf, "gamma")
surf %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig4_losDensity")

```
# median distribution

```{r}

largerOf = function(x,y) {return(ifelse(x>y,x,y))}
smallerOf = function(x,y) {return(ifelse(x<y,x,y))}

(ggplot(survSurf %>% filter(model=="gamma") %>% mutate(median_lo = ifelse(is.na(median_lo),0,median_lo)),aes(x=ageCat,y=median,ymin=smallerOf(median_lo,median_hi),ymax=largerOf(median_lo,median_hi), group=1))+geom_line()+geom_ribbon(alpha=0.2)+xlab("age")+ylab("median length of stay")) %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig5_losMedianByAge")

```


# incidence surfaces 

more important for other transitions where we are looking at 

```{r}
surf2 = plotIncidenceSurface(survSurf, "gamma")
surf2
```

```{r}
survSurfcsv = out %>% createSurvivalSurfaces(timepoints = 0:45)
write.csv(
  survSurfcsv %>% ungroup() %>% mutate(surv = 1-cdf),
  file="~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/itu-admission-to-itu-discharge.csv")        
plotProbabilityMatrix(survSurfcsv,"gamma",pExpr=1-cdf) %>% saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/daily_probability_by_age")

```


<!-- # validate against Bristol data -->

<!-- Do a set of Kolmogorov-Smirnov tests on different combinations of parameters and log normal distributions -->

<!-- ```{r} -->
<!-- bri = getBristolData(paths$bristol) -->
<!-- bri2 = bri %>% bristolSurvivalSubset()  -->
<!-- bri3 = bri2 %>% generateSurvivalData( -->
<!--   idVar = record_number, -->
<!--   startDateVar = admission_date, -->
<!--   endDateExpr = discharge_date, -->
<!--   statusLabels = c("censored","disch or died") -->
<!-- ) -->

<!-- doKSTest = function(d,g,paramNames,params,n) { -->
<!--   sample = d$time -->
<!--   params = as.list(params) -->
<!--   names(params) = paramNames -->
<!--   params$x = jitter(sample) -->
<!--   params$y = "plnorm" -->
<!--   # browser() -->
<!--   ks = do.call("ks.test",params) -->
<!--   return(tibble( -->
<!--     testN = length(sample), -->
<!--     referenceN = max(n), -->
<!--     pValue = ks$p.value, -->
<!--     dStatistic = ks$statistic -->
<!--   )) -->
<!-- } -->

<!-- gofBri = bri3 %>% filter(status == "disch or died") %>% group_by(ageCat) %>% group_modify(function(d,g,...) { -->
<!--   reference = out %>% filter(model == "lnorm" & ageCat == g$ageCat) -->
<!--   out = bind_rows( -->
<!--     doKSTest(d,g,reference$param, reference$value, reference$n) %>% mutate(estimate = "central"), -->
<!--     doKSTest(d,g,reference$param, reference$low_ci, reference$n) %>% mutate(estimate = "low credible"), -->
<!--     doKSTest(d,g,reference$param, reference$high_ci, reference$n) %>% mutate(estimate = "high credible") -->
<!--   ) -->
<!-- }) -->

<!-- numbers = gofBri %>% select(ageCat,estimate,test=testN,fit=referenceN) %>% pivot_longer(cols=c("test","fit"),names_to = "source", values_to = "N") -->

<!-- top = ggplot(gofBri, aes(x=ageCat,y=pValue,fill=estimate))+geom_bar(stat="identity", position="dodge", width=0.7, colour="black")+standardPrintOutput::narrowAndTall()+theme(axis.text.x = element_blank(), axis.title.x = element_blank())+ylab("P value") -->
<!-- bottom = ggplot(numbers, aes(x=ageCat,y=source,label=N, colour = source))+geom_text()+guides(colour="none")+theme(panel.grid = element_blank(),axis.title.x = element_blank())+ylab("N") -->

<!-- (top+bottom+patchwork::guide_area()+patchwork::plot_layout(ncol=1, heights = c(9,2,1), guides = "collect")) %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/ventilator-demand/parameterisation/itu-admission-to-itu-discharge/Fig6_validateBristol") -->
<!-- ``` -->

<!-- Suggests the fitted distributions to the UK wide data reasonably describes the Bristol data from 30-70 year olds. The high credible estimates are closer to the bristol data in the older age group.  -->

<!-- Possible that my exclusion of hospitals with high numbers of censoring was too enthusiastic, and this would tend to drive down the LOS. Alternatively Bristol OAPs stay longer in hospital as they don't die as quickly as the rest of the country. -->

<!-- # unsing surv -->

<!-- ```{r} -->


<!-- crlnorm <- flexsurv::flexsurvreg(Surv(time, status != "censored") ~ ageCat, data = admissionToDischargeOrDeath, dist = "gamma") -->
<!-- crlnorm -->

<!-- ``` -->