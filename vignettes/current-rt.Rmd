---
title: "Estimates of regional infectivity of COVID-19 in the United Kingdom following imposition of social distancing measures"
date: '`r format(Sys.Date(), "%d-%m-%Y")`'
output: 
  pdf_document :
    fig_caption: yes
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}    

knit: (function(inputFile, encoding,...) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "~/Dropbox/covid19/current-rt", output_file=paste0('current-rt-',Sys.Date(),'.pdf')) })
fig_width: 7
fig_height: 5
out.width: "100%"
bibliography: current-rt.bib
csl: current-rt.csl
vignette: >
  %\VignetteIndexEntry{Regional infectivity of COVID-19}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align="center"
)
```

```{r setup}
library(tidyverse)


# devtools::install_github("terminological/uk-covid-datatools")
# library(ukcovidtools)
devtools::load_all("~/Git/standard-print-output/")
#library(rgdal)
library(ggplot2)
#library(ggspatial)
#library(rgeos)
#library(maptools)
#library(lubridate)
library(patchwork)
#library(sp)

standardPrintOutput::setDefaults()

cap = list(
  fig = captioner::captioner(prefix="Figure"),
  tab = captioner::captioner(prefix="Table"),
  sfig = captioner::captioner(prefix="Supplemental figure"),
  stab = captioner::captioner(prefix="Supplemental table")
)

ref = list(
  fig = function(name) cap$fig(name,display="cite"),
  tab = function(name) cap$tab(name,display="cite"),
  sfig = function(name) cap$sfig(name,display="cite"),
  stab = function(name) cap$stab(name,display="cite")
)

#source("~/Git/uk-covid-datatools/vignettes/cron-estimate-rt.R")
currentRt = c(
  readRDS("~/Dropbox/covid19/current-rt/submission/CURRENT-DATASET-2020-08-19.rda"),
  readRDS("~/Dropbox/covid19/current-rt/submission/CURRENT-RT-QUICK-2020-08-19.rda"),
  readRDS("~/Dropbox/covid19/current-rt/submission/CURRENT-RT-SLOW-2020-08-19.rda")
)

dpc = tsp = chp = srv = mwp = NULL

reload = function() {
  devtools::load_all("~/Git/uk-covid-datatools/")
  dpc <<- DataProviderController$setup("~/Data/maps/", "~/S3/encrypted/")
  tsp <<- dpc$timeseriesProcessor()
  # tsp$printSerialInterval()
  chp <<- dpc$chessProcessor()
  srv <<- dpc$survivalProcessor()
  mwp <<- dpc$metawardProcessor()
}



reload()
usedSerial = SerialIntervalProvider$resampledSerialInterval(dpc)
 
```

Robert Challen^1,2^; Krasimira Tsaneva-Atanasova^1,3^; Martin Pitt^4^;
Tom Edwards^2^; Luke Gompels^2^; Lucas Lacasa^5^; Ellen
Brooks-Pollock^6^; Leon Danon^3,7^

1)  EPSRC Centre for Predictive Modelling in Healthcare, University of Exeter, Exeter, Devon, UK.
2)  Taunton and Somerset NHS Foundation Trust, Taunton, Somerset, UK.
3)  The Alan Turing Institute, British Library, 96 Euston Rd, London NW1 2DB, UK.
4)  NIHR CLAHRC for the South West Peninsula, St Luke’s Campus, University of Exeter Medical School, Exeter, UK.
5)  School of Mathematical Sciences, Queen Mary University of London, London E1 4NS, UK
6)  Bristol Medical School, Population Health Sciences, University of Bristol, Bristol, UK
7)  Data Science Institute, College of Engineering, Mathematics and Physical Sciences, University of Exeter, Exeter, UK.

# Abstract

***This paper describes the methods employed for estimation of the reproduction number of SARS-CoV-2 infection produced by the University of Exeter to support the monitoring and response to the outbreak of COVID-19 in the UK. Furthermore it describes regional variation observed in the UK and how these evolved during the early phases of the outbreak, until the relaxing of social distancing measures began to be introduced in early July. The understanding of spatial variations helps to better understand the state of the epidemic as we move forward.***

Keywords : COVID-19; SARS-CoV-2; reproduction number; regional
variation;

Competing interests: Support for RC and KTA’s research is provided by the EPSRC via grant EP/N014391/1, RC is also funded by TSFT as part of the NHS Global Digital Exemplar programme (GDE); no financial relationships with any organisations that might have an interest in the submitted work in the previous three years, no other relationships or activities that could appear to have influenced the submitted work.

Funding: RCh and KTA gratefully acknowledges the financial support of the EPSRC via grant EP/N014391/1 and NHS England, Global Digital Exemplar programme. LD and KTA gratefully acknowledges the financial support of The Alan Turing Institute under the EPSRC grant EP/N510129/1. LL acknowledges the financial support of the EPSRC via Early Career Fellowship EP/P01660X/1.

Authors contributions: All authors discussed the concept of the article and RC wrote the initial draft. KTA, MP, TE, LG, LL, EB-P and LD commented and made revisions. All authors read and approved the final manuscript. RC is the guarantor. The views presented here are those of the authors and should not be attributed to TSFT or the GDE.

# Introduction

In late 2019 an outbreak of a novel infectious disease was detected. It manifested principally with severe acute respiratory distress, and pneumonia, [@huangClinicalFeaturesPatients2020] although many cases followed a mild course [@wuCharacteristicsImportantLessons2020]. The pathogen was rapidly identified as a new species of coronavirus
(severe acute respiratory syndrome coronavirus 2 - SARS-CoV-2), and the disease named COVID-19 [@NamingCoronavirusDisease]. Global transmission of the virus followed and major outbreaks have been observed in Europe, beginning with Italy [@ceredaEarlyPhaseCOVID192020]. On the 31st Jan 2020 the first cases were identified in the UK [@mossLessonsManagingHighconsequence2020]. This was initially managed using testing of suspected individuals in the
community, contact tracing and isolation of affected cases. However this was successful only in delaying the spread of the disease and on 13th March 2020 the UK government moved towards a mitigation strategy reserving testing for hospital inpatients only [@publichealthenglandCOVID19InvestigationInitial2020]. Following this, a step wise implementation of social distancing measures were mandated by the government including voluntary self isolation of any symptoms & vulnerable people [@publichealthenglandCOVID19GuidanceSocial2020], a ban on non essential travel worldwide [@foreignTravelAdviceCoronavirus2020]
and school closures [@departmentforeducationClosureEducationalSettings2020]. Finally on 23rd March 2020 the government mandated that everyone apart from essential workers should stay at home and away from others [@cabinetofficeFullGuidanceStaying2020], instituting a countrywide "lock-down ".

Epidemiological studies conducted during the outbreak in China have provided us with a number of estimates of the parameters describing the virus’s spread through the population including a reproduction number between 2.24 and 3.58 [@zhaoPreliminaryEstimationBasic2020] and a median incubation period of 5.1 days (credible interval 4.5 to 5.8) [@lauerIncubationPeriodCoronavirus2020]. It is estimated that fewer than 2.5% of people will show signs before 2.2 days and 97.5% of people who will develop symptoms will have done so by 11.2 days after exposure [@lauerIncubationPeriodCoronavirus2020].

As part of the University of Exeter's contribution to the work of the Scientific Pandemic Influenza Group on Modelling (SPI-M)[@ScientificPandemicInfluenza], we investigated the reproduction number of SARS-CoV-2 in the UK to determine whether there are any spatial or temporal patterns beyond those resulting from the imposition of social distancing measure, and to track the progression of the outbreak. This article summarizes the methodology and interpretation of national and regional estimates of the time varying reproduction number ($R_t$) of the SARS-CoV-2 outbreak in the United Kingdom.

# Methods

This section addresses the data sources and processing applied, the combination of data sources, our estimation of the serial interval of SARS-CoV-2 infections, and calculation of $R_t$ estimates.

## Data
We integrate data from a variety of sources, both publicly available and provided to SPI-M by Public Health England (PHE) and the Defence Science and Technology Laboratory [dstl][@DefenceScienceTechnology]. We use this data to estimate $R_t$ and the exponential growth rate for the UK, for the four nations of the UK, (CTRY) and for the seven NHS regions in England (NHSER). 

At the UK level data is available on cases and deaths by the PHE coronavirus tracker [@publichealthenglandTotalUKCOVID19]. The PHE coronavirus tracker [@publichealthenglandTotalUKCOVID19] publishes an overall figure for cases and deaths in the UK on a daily basis. It also produces a regional breakdown of the 4 nations, which exclude tests performed in private laboratories (Pillar 2 tests). A historical time series of the UK level data is not made available though the PHE site. However the data has been collected prospectively and curated by Tom White's aggregated COVID 19 UK data github site [@whiteCovid19ukdata]. Cumulative case counts from both the PHE headline UK figure and the combined sum of the 4 nations are compared as these numbers differ. 

Hospital admission data is available from NHS trusts across the UK via the [dstl] provided data feeds, which in turn aggregate the situation reports (SitReps) provided by NHS hospital trusts. This data is aggregated to UK level. Although referred to here as "hospital admission" it includes admissions of patients who are subsequently identified as COVID-19 cases in hospital, but identified in hospital, and patients with known COVID-19 who are then admitted to hospital.

For the 4 nations of the UK, we used data from the SPI-M provided line lists for cases and deaths in England. The cases are restricted to those processed in NHS labs (Pillar 1), and is available by date of specimen collection. For the other 4 nation states of the UK, as above, both historical cases and death data is aggregated from Public Health Wales [@PublicHealthWales] and Scotland's [@CoronavirusScotlandGov] sites, and from Northern Ireland's HSC site [@COVID19SurveillanceReports], using a time series retrieved from Tom White's aggregated COVID 19 UK data github site [@whiteCovid19ukdata] for Scotland, Wales and Northern Ireland data. Death data from the 4 nations is also provided by the [dstl], via the CHESS data set [@CoronavirusCOVID19Using]. Death data is subject to a weekly periodicity due to reporting delay over the weekend which is mitigated by using date of death rather than date of report.

At the level of the NHS England regions, we take the case data from SPI-M provided anonymised test result line listings. Mortality data for NHS England is provided to SPI-M by PHE in a canonical line list of deaths, and this is used alongside the CHESS data set[@CoronavirusCOVID19Using]. Admissions data is available from [dstl] feeds, and ICU admissions from CHESS data set[@CoronavirusCOVID19Using].

For England as a nation and for the NHS England regions we also have data available from triage telephone calls from NHS 111 and 999 services. The data on the calls made to 111 & 999 as well as the outcome of that call are provided to SPI-M via the [dstl]. These are used to produce additional estimates for SPI-M, and will be described in detail elsewhere, but in brief the number of 111 calls or 999 calls that go through the 111 or 999 coronavirus assessment pathway and result in an ambulance being dispatched or an urgent clinical review being scheduled are used as an indicator of a potential coronavirus case.

For all data sources cumulative case figures are converted into daily incidence figures, and any data which is broken down by age, or by gender, are combined. In case and death data which may be subject to reporting delay the final 5 days of the time series is discarded. The resulting time series are analysed for outlying data points, which are more than 5 standard deviations away from the mean of the nearest 14 data points. Missing values are imputed using the R "forecast" library [@ForecastingFunctionsTime], the results of which are truncated ensuring no negative incidence figures. Outlying or missing data are imputed from a linear interpolation of the logarithm of incidence figures. Prior to calculation of $R_t$ a smoothing function (a linear spline interpolation) is fitted to the logarithm of incidence applied over a 7 day window [@loaderLocfitLocalRegression2020]. This is needed as all the data sources have some degree of weekly periodicity regardless of source. 

## Combination of data sources

Our best estimates are based on an aggregation of the various data sources described above. The various data sources described above are aggregated to form a single time series for triage calls, cases, hospital admission, and deaths. This feeds 4 models used to estimate $R_t$, one based on deaths (EpiEstim/Deaths), one based on cases (EpiEstim/4NationsCases), one based on telephone triage (EpiEstim/Triage), and an additional model based on hospital admissions. The aggregation procedure is kept simple and combined multiple data sources when applicable using the mean. Any inconsistencies this introduces are consistent throughout the time series so does not affect relative changes and hence either estimates of $R_t$ or of growth rates. The resulting time series are manually inspected for consistency and to check there are not large changes in the data sources. The final source of the combined data sets and more information about the processing steps used is shown in `r ref$stab("data-source")`. 

## The serial interval of SARS-CoV-2 infections, $R_t$, and time delay of estimates

The generation interval is a measure of the time taken for an infection to pass from one person (infector) to another (infectee) in a chain of transmission. The generation interval is not observed directly as both infection events are only detectable once the virus has incubated and become clinically detectable. The serial interval is a proxy measure based on the time between onset of symptoms. Use of the serial interval as a proxy for the generation interval is known to produce biased estimates for the reproduction number [@brittonEstimationEmergingEpidemics2019; @gosticPracticalConsiderationsMeasuring2020], but it has the advantage that it can be directly observed it through contact tracing. 

Assumptions about the serial interval of SARS-CoV-2 have an impact on the absolute level of our estimates of $R_t$. We have used different approaches to estimate the serial interval. Firstly a UK specific serial interval was calculated from early case tracking data (the FF100 case data provided by [dstl]). Secondly a literature review was conducted and the serial intervals from a range of sources[@biEpidemiologyTransmissionCOVID192020; @ceredaEarlyPhaseCOVID192020; @duSerialIntervalCOVID192020; @ganyaniEstimatingGenerationInterval2020; @liEarlyTransmissionDynamics2020; @nishiuraSerialIntervalNovel2020; @tindaleEvidenceTransmissionCOVID192020; @xuHouseholdTransmissionsSARSCoV22020; @youEstimationTimevaryingReproduction2020; @zhangEvolvingEpidemiologyTransmission2020; @zhaoEstimatingSerialInterval2020] pooled. This pooling was conducted using both bootstrap re-sampling and a simpler weighted consensus approach. The detail of our pooling analysis is available separately, but the conclusion is that we assume the serial interval can be described by a `r usedSerial$printSerialInterval()`. This uncertainty of serial intervals distribution is used to generate a range of estimates for $R_t$ using bootstrapping, which are combined to determine the confidence intervals in our estimates of $R_t$.

Using the inferred serial interval distribution, we analysed the time series data using R [@rcoreteamLanguageEnvironmentStatistical2017] and the EpiEstim [@coriEstimateTimeVarying; @coriNewFrameworkSoftware2013; @thompsonImprovedInferenceTimevarying2019] library which implements the Cori method [@coriEstimateTimeVarying] to estimate the time varying reproduction numbers during the outbreak. We make the underlying assumption that there is negligible mixing of populations between each geographical area. 

The Cori method is predicated on a time series of infections, and on a measure of the probability that a secondary infection occurred on a specific day after the primary case, given a secondary infection occurred, which is described as the "infectivity profile" [@coriEstimateTimeVarying]. It uses a Bayesian framework to update a prior probabilistic estimate of $R_t$, on any given day, with both information gained from the time series of infections in the epidemic to date, and the infectivity profile, to produce a posterior estimate of $R_t$. With the assumption that prior and posterior estimates of $R_t$ are gamma distributed, the Cori method derives a closed form solution for the posterior distribution, which can be rapidly calculated. In both the original [@coriNewFrameworkSoftware2013] and revised [@thompsonImprovedInferenceTimevarying2019] implementations of the Cori method, the authors acknowledge the pragmatic use of the serial interval distribution, as proxy measure for the infectivity profile, and incidence of symptom onset or case identification as a proxy for the incidence of infection, with the caveat that these introduce a time lag into the estimates of $R_t$.

The method uses a sliding time window during which the instantaneous reproduction number is assumed to be constant. We empirically decided on using both a 7 day and a 28 day sliding window for calculations of the time varying reproduction
number which provides two estimates with alternative trade offs between noise and loss of detail. Our $R_t$ estimation assumes a prior mean $R_0$ of 1 and standard deviation 2. This prior distribution is an assumption on the conditions following lock-down, rather than reflecting values of $R_0$ commonly described in the literature [@zhaoPreliminaryEstimationBasic2020] as it is a more natural value for the UK at that time.

There are other events in the time line of an infection, for example positive testing, hospitalization for severe disease, or death, which are a proxy for observations of infections in the past. Whilst we accept that best practice is to calculate $R_t$ using a generation interval distribution and infection events[@gosticPracticalConsiderationsMeasuring2020], neither the generation interval distribution nor the infection event data are directly observed, and we argue that inferring them can also introduces potential bias, and considerable uncertainty. As a pragmatic initial step, accepting there will be bias in our estimates, we use the serial interval distribution described above in lieu of the generation interval, and the various observations available to us, such as triage contacts, cases, admissions and deaths as a proxy of prior transmission events, and compare those results.

There is a time delay between infection, symptom onset, case identification, hospital admission and ultimately death, and this affects the timing of our estimation of $R_t$. In a separate analysis we estimated these time delays (shown in `r ref$stab("time-delays")`) and apply these estimates as a correction to the time of our estimates of $R_t$ to align them to date of presumed infection.

The resulting estimated figures here are essentially spot observations of historical $R_t$ based on the published data. They are not estimates of the underlying "true" value of $R_t$, or projections of $R_t$.

# Results

## UK Overview

```{r}
tidyUp = function(df) {
  return(df %>%
    mutate(
      `Count per 1M per day (95% CI)` = sprintf("%1.1f (%1.1f; %1.1f)",Est.value/population*1000000, Est.Quantile.0.025.value/population*1000000, Est.Quantile.0.975.value/population*1000000),
      source = ifelse(source=="4NationsCases","Cases",source),
      `R(t) (95% CI)` = sprintf("%1.2f (%1.2f; %1.2f)",`Median(R)`,`Quantile.0.025(R)`,`Quantile.0.975(R)`)
    )       
  )
}

latestDate = as.Date("2020-07-04")
earliestDate1 = as.Date("2020-02-12")
earliestDate2 = as.Date("2020-03-21")
events1 = dpc$datasets$getSignificantDates() %>% filter(Label %in% c("Feb half term","Tracing stop","lock-down ","VE day","All shops reopen","Hotels and bars reopen"))
events2 = dpc$datasets$getSignificantDates() %>% filter(Label %in% c("lock-down ","VE day","All shops reopen","Hotels and bars reopen"))

```

Our estimate of the median value of $R_t$ based for the United Kingdom based on cases, deaths and hospital admissions from the 4th July 2020 is presented in `r ref$tab("uk-rt")`. 

`r cap$tab("uk-rt","Estimates of the value of $R_t$ in the UK on 4th July 2020")`

```{r}
#r0UK = currentRt$rtAssumed %>% tsp$adjustRtCorrFac() %>% tidyUp() %>% filter(codeType=="UK") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate)
#r0UK = currentRt$rtAssumed %>% tidyUp() %>% filter(codeType=="UK") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate)
r0UK = currentRt$rt %>% tidyUp() %>% filter(codeType=="UK") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate)
#r0UK = currentRt$rt %>% tidyUp() %>% filter(codeType=="UK") %>% filter(date > earliestDate1 & date <= latestDate)
r0UK %>% filter(date==latestDate) %>% ungroup() %>% select(`Observation`=source,`R(t) (95% CI)`, `Count per 1M per day (95% CI)`) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table2_ukRt",defaultFontSize = 8)

maxRcases = r0UK %>% filter(statistic=="case") %>% pull(`Median(R)`) %>% max() %>% sprintf(fmt = "%1.1f")
maxRadmissions = r0UK %>% filter(statistic=="hospital admission") %>% pull(`Median(R)`) %>% max() %>% sprintf(fmt = "%1.1f")
maxRdeaths = r0UK %>% filter(statistic=="death") %>% pull(`Median(R)`) %>% max() %>% sprintf(fmt = "%1.1f")
```

`r ref$fig("uk-rt-timeseries")`, panel A, shows the incidence per million people of cases, deaths, and hospital admissions due to COVID-19 in the UK over the outbreak, on a logarithmic scale. Panel B shows the associated values for $R_t$. The 3 data sources show similar pattern of exponential rise, with admissions and deaths lagging cases followed by a slower phase of exponential decline, beginning 2-3 weeks after the lock-down , with a slightly faster rate of exponential decline in case numbers. In Panel B we see the estimates of $R_t$ rate corrected to date of infection. There is a prominent single initial peak in $R_t$ estimates from admissions and deaths peaking in late February, and progressively declining over the course of the next few months, crossing one about the beginning of April, after which they have remained less than one during the lock-down  period. Estimates based on cases show a biphasic pattern with initial peak in mid February and a second smaller peak in early March, but then subsequently following the same pattern as other estimates. The peak values of $R_t$ vary by observation with peak $R_t$ by admissions being `r maxRadmissions`, by cases `r maxRcases` and by deaths `r maxRdeaths`. These are within the confidence limits of estimates described in other countries [@zhaoPreliminaryEstimationBasic2020].

```{r fig1}

p1 = tsp$plotIncidenceQuantiles(
    r0UK, 
    denominatorExpr = population/1000000, 
    events = events1, 
    dates = c(earliestDate1, latestDate),
    colour=statistic, 
    ylim=c(0,150))+
  #facet_wrap(vars(name),ncol=4)#+
  #theme(axis.title.x = element_blank(),axis.text.x = element_blank())+
  xlab("date of observation")+
  scale_color_brewer(palette="Dark2",aesthetics = c("colour","fill"))+
  scale_y_continuous(trans="log1p", breaks = c(0,5,15,50,150))+ylab("Count per 1M per day")
p2 = tsp$plotRt(
    r0UK, 
    events = events1, 
    dates = c(earliestDate1, latestDate),
    colour=statistic, 
    rtlim = c(0.5,6), ribbons=TRUE)+xlab("date of infection")+
    scale_color_brewer(palette="Dark2",aesthetics = c("colour","fill"))
  #facet_wrap(vars(name),ncol=4)+
  #theme(legend.position = "bottom")

r0ukplot = p1+p2+patchwork::plot_annotation(tag_levels = "A") +patchwork::plot_layout(ncol=1,guides = "collect")
r0ukplot %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/current-rt/Fig1_ukRt")

```

`r cap$fig("uk-rt-timeseries", "Panel A is the count per million population per day of cases (Pillar 1), deaths and admissions, and panel B the timeseries of $R_t$ estimates in the UK based on either cases reported by PHE and NHS labs, or deaths reported in NHS trusts, or on best available data for admissions. Red points are either missing values or identified as anomalies and replacements imputed")`

<!-- TODO: test positivity rates: http://freerangestats.info/blog/2020/05/09/covid-population-incidence -->

## Countries in the UK

Estimates of the $R_t$ in the different countries of the UK, based on cases, deaths, hospital admissions or triage calls for the 4th July 2020 is presented in `r ref$tab("ctry-rt")` and `r ref$fig("ctry-rt-timeseries")`. Triage figures based on 111 & 999 coronavirus pathway calls were available for England only, and we do not have full time series of all information for all countries. We show here estimates based on a 28 day rolling window as cases and deaths in Northern Ireland, and Scotland, have fallen to a level which makes estimates over a shorter window unreliable. With insufficient information EpiEstim will revert its estimates of $R_t$ to the prior value of $R_0$ supplied which in this instance is set at 1. These estimates for each nation of the UK shows the median value of $R_t$ is below 1 for all 4 nations, using all data sources. The pattern in all nations is similar with $R_t$ rapidly decreasing following lock-down on the 23rd March and becoming less than one in mid April. Subsequent to this it is apparent that Northern Ireland and Scotland have maintained a lower $R_t$ for a longer period of time than England and Wales, with $R_t$ values in Northern Ireland and Scotland at or below 0.75 for much of May, June and July compared to those in England and Wales which have been between 0.75 and 1 for the same period.

`r cap$tab("ctry-rt", "Estimates of Mean $R_t$ and 95% confidence intervals for the individual countries in the United Kingdom, based on cases, deaths and hospital admissions on the 4th July 2020")`

```{r}
r0CTRY = currentRt$rt28 %>% tidyUp() %>% filter(codeType=="CTRY") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate)
r0CTRY %>% filter(date==latestDate) %>% ungroup() %>% select(`Country`=name,`Observation`=source,`R(t) (95% CI)`, `Count per 1M per day (95% CI)`) %>% group_by(Country) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table3_ukCountryRt",defaultFontSize = 8)
```

```{r fig2}
r0nationsplot = tsp$plotRt(
    r0CTRY, 
    events = events2, 
    dates = c(earliestDate2, latestDate), 
    colour=statistic, 
    rtlim = c(0.5,1.5), 
    ribbons=TRUE
  )+
  scale_color_brewer(palette="Dark2",aesthetics = c("colour","fill"))+
  facet_wrap(vars(name),ncol=2)
#r0ukplot = p1+p2+patchwork::plot_layout(ncol=1,guides = "collect")
r0nationsplot %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/current-rt/Fig2_ukRegionRtDeaths")
```

`r cap$fig("ctry-rt-timeseries", "The median value of $R_t$ and 95% confidence intervals for the individual countries in the United Kingdom, based on cases, deaths and hospital admissions, and a 28 day rolling window. Red points represent data points that were missing and have been imputed")`

## $R_t$ by England NHS region

In `r ref$fig("nhser-rt-timeseries")` (and, for completeness, `r ref$stab("nhser-rt")`) we present the same analysis as above but with a focus on the NHS regions in England. On the 4th July 2020 the estimates of the mean of $R_t$ were largely below 1 in the individual NHS regions, however in some areas this is only just the case, and in the Midlands, our mean estimate based on cases was slightly above 1 possibly due to an evolving outbreak in Leicester. The observed count of different observations demonstrates a clear regional difference between London and the South West and the rest of the country with lower rates of all indicators than other regions. The time series of regional estimates of $R_t$ reflect the overall patterns of England, albeit with more volatility due to the different windowing size between `r ref$fig("ctry-rt-timeseries")` and `r ref$fig("nhser-rt-timeseries")`. It is however possible to see higher levels of uncertainty in the South West reflecting the smaller case numbers and to a lesser extent the same in London.


```{r fig3}
#p1=tsp$plotIncidencePer100K(r0UK,group = statistic,linetype=version,events=events,dates = "2020-03-21")+scale_y_continuous(trans="log1p")
r0NHSER = currentRt$rt %>% tidyUp() %>% filter(codeType=="NHSER" & statistic != "icu admission") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate)
r0regionsplot=tsp$plotRt(
    r0NHSER, 
    events = events2, 
    dates = c(earliestDate2,latestDate),
    colour=statistic, 
    rtlim = c(0.5,1.5), ribbons=TRUE)+
  scale_color_brewer(palette="Dark2",aesthetics = c("colour","fill"))+
  facet_wrap(vars(name),ncol=2)
#r0ukplot = p1+p2+patchwork::plot_layout(ncol=1,guides = "collect")
r0regionsplot %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/current-rt/Fig3-NHSregionRt")
```

`r cap$fig("nhser-rt-timeseries", "The median value of $R_t$ and 95% confidence intervals for the sub-national regions of NHS England, based on cases, deaths and hospital admissions, and a 7 day rolling window.")`


## $R_t$ differences from England baseline

In `r ref$fig("nhser-delta-rt")` we plot the absolute difference of $R_t$ in the 7 NHS England administrative regions, from the $R_t$ of England overall, as a baseline based on 28 day window estimates due to the volatility observed in `r ref$fig("nhser-rt-timeseries")`. This analysis highlights the regional differences in $R_t$ over time. Over the period of the lock-down, the East of England, Midlands and South East regions approximately tracked the England baseline. The South West was seen to initially following the national trend but may have a trend towards a lower $R_t$ since early June, although our confidence in these estimates is low. By most indicators, London initially was markedly below the England average, until some point in late May, when this trend reversed. On the other hand the North West, and less so North East & Yorkshire were consistently marginally above the England baseline until late May when they finally approached the England average, but since mid June the $R_t$ estimates in the North West have been trending below the UK average. The impact this has had on regional case loads is seen in `r ref$tab("nhser-delta-counts")` which shows the pre and post lock-down rates of newly identified cases in each region.

```{r}

tmp = currentRt$rt28 %>% tidyUp() %>% 
  filter(codeType=="CTRY") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate) %>% 
  filter(name == "England") %>% select(date,source,baseline=`Median(R)`)

englandnhsFromBaseline = 
  currentRt$rt28 %>% tidyUp() %>% 
  filter(codeType=="NHSER") %>% tsp$adjustRtDates(window=0, extraCols="R(t) (95% CI)") %>% filter(date > earliestDate1 & date <= latestDate) %>% 
  inner_join(tmp, by=c("date","source")) %>% mutate(
  `$R_t$ from baseline`=`Median(R)`-baseline, ymin=`Quantile.0.025(R)`-baseline, ymax=`Quantile.0.975(R)`-baseline
)

#glimpse(ts$tidyEnglandNHS)
englandnhsplot = tsp$plotDefault(data = englandnhsFromBaseline, events = events2, dates = c("2020-03-23","2020-07-04"), ylim=c(-0.15,0.15))+
  geom_ribbon(aes(ymin=ymin, ymax=ymax,group=source),alpha=0.065,fill="black")+
  geom_line(aes(colour=source, x=date, y=`$R_t$ from baseline`),linetype="f1")+
  geom_hline(yintercept=0,colour="grey50")+
  scale_color_brewer(palette="Dark2",aesthetics = c("colour","fill"))+
  facet_wrap(vars(name)) + ylab(latex2exp::TeX("$\\Delta R_t$ from baseline"))
  
englandnhsplot %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/current-rt/Fig4-NHSregionDeltaRt")
```

`r cap$fig("nhser-delta-rt", "The difference of $R_t$ estimates for NHS regions and baseline $R_t$ estimates for England, based on cases, deaths and hospital admissions, and a 28 day rolling window.")`

`r cap$tab("nhser-delta-counts", "Estimates of the burden of disease before and after lock-down  in the different NHS regions.")`

```{r}
r0NHSER %>% filter(date %in% c(earliestDate2,latestDate), source=="Cases") %>% ungroup() %>% select(`NHS Region`=name,`Date` = date,`Count per 1M per day (95% CI)`) %>% 
  mutate(Date = paste0("Cases per 1M per day (95% CI) on ", as.character.Date(Date,"%d %b"))) %>%
  pivot_wider(names_from = `Date`, values_from = `Count per 1M per day (95% CI)`) %>% 
  standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table4_NHSERDeltaCases",defaultFontSize = 8)
```

# Discussion

We estimate the reproduction number in the UK using a set of metrics, but the same estimation methodology, which we acknowledge to be potentially biased[@brittonEstimationEmergingEpidemics2019; @gosticPracticalConsiderationsMeasuring2020]. In general over a range of geographies and time points we find different data sources produce similar results, without evidence of systematic bias for estimates based on more immediate measures (such as cases), compared to those based on longer term measures (such as deaths). The estimates were found to be comparable to those produced by different members of SPI-M using different methods [@NumberGrowthRate]. 

We found $R_t$ peaked in mid February (estimated at date of infection) and coincided with the end of the February half term school holiday. We do find quite different estimates for the size of the initial peak depending on the data source we used, which all come with considerable uncertainty. This variance could be the result of the biases described in our methodology, or variability in the data sources in early phase of outbreak.

During the early part of the outbreak there were a number of changes in testing strategies that took place. Initially there were attempts at community tracing which were abandoned when case numbers started to outstrip test availability. After this testing was only performed on hospital admissions for suspected COVID-19 [@publichealthenglandCOVID19InvestigationInitial2020]. Subsequent to this test capacity was increased and this policy reversed to include more community cases. These changes in testing strategy altered the nature of the population being tested and hence the rate of cases discovered, and is one explanation for the biphasic nature, and the increased width of the peak of our case based $R_t$ estimates. Moving out of the lock-down   we see a similar effect as test and trace activity increases, although in this case the community tracing activity (Pillar 2 testing) is included in a different data stream and deliberately excluded from this analysis.

The comparatively high admissions estimates of the peak based on hospital admissions highlights another potential source of bias in the data, in that as hospital admission statistics include cases identified in hospital, in the early phase when clinical suspicion was low, and test availability reduced, there were initial delays in cases being identified. This compresses the early part of the time series and hence increases the apparent speed of the outbreak. 

The estimates based on deaths are relatively low. This could be explained by the shielding policy of elderly and vulnerable adults, who although heavily affected by the outbreak, tended to be involved later. As COVID-19 mortality is overwhelmingly in the elderly, statistics based on deaths mainly represent that age group, and due to reduced contact in the elderly we propose the outbreak took longer to become established in those age groups. This is one explanation for the smaller initial peak of $R_t$ estimates based on deaths. 

Examining the national breakdown of countries in the UK in `r ref$fig("ctry-rt-timeseries")` we see further evidence for this effect in the data we have available on telephone triage calls. Triage based estimates of $R_t$ show good agreement with estimates from other sources until the lock-down begins to be eased in early to mid June. At this point our triage-based $R_t$ estimates, available only in England, diverge to a somewhat higher level. Compared to the other data sources, triage calls reflect the situation in the younger age groups in the community, who are less at risk of serious consequences from COVID-19, have begun to socialize more freely as restrictions are eased.

In `r ref$fig("nhser-delta-rt")` we investigated how the regional estimates of $R_t$ differ from the national estimates in England, and we noted that estimates of $R_t$ were lowest in London and highest in the North West and North East of England. The burden of cases was highest in London during the early phase of the outbreak at nearly 50 cases per million people per day, but 
this has reduced 25 fold over the lock-down . In the North East on the other hand the sevenfold reduction was more modest. Exiting lock-down  case rates per capita are lowest in the South West, due to the smaller inital outbreak there, followed by London due to the larger impact of social distancing. However the benefit that London has in case rates may well be offset by the above national average estimated $R_t$. Enhanced social distancing measures in the North West and North East may mitigate the otherwise comparably high rates. All of this should be caveated by the observation that the South West, as the least affected region so far, will continue to have the highest level of susceptible people in the population.

# Limitations

There are a number of important limitations in our methods that have been explained above, and we have based this analysis on a pragmatic use of available data, with the objective of highlighting differences and biases within the data. We believe useful interpretation of estimates based on these data is still possible.

One limitation not addressed above is that we have no information on the rate of importation of cases and assume the system is closed. In the early phases importation rates have been estimated to be high[@PreliminaryAnalysisSARSCoV22020], and this would tend to bring our estimates of $R_t$ down.

The time series data we have collected has data quality issues identified in the methods section, which has required some data
cleansing and imputation. There are also somewhat complex and different definitions of admission adopted in different countries of the UK and these have changed over time, all of which will introduce complex biases into our estimates. 

There is an inherent assumption that limited travel has occurred during the period of estimation. This assumption is probably valid during the earlier part of the lock-down  period but this will be increasingly less valid as lock-down eases.

The precise date at which to attribute a particular value of $R_t$ is somewhat uncertain as the observed events (cases, deaths, admissions) are distant in time to the underlying event of interest (infections), and the relationship between them is changing as the outbreak unfolds. Our $R_t$ estimates are corrected for the overall lag between observations using our best available estimates. There is the opportunity to use time series cross correlation analysis on the various national and regional $R_t$ time series to better characterize how this delay evolves though time, which is a subject of future work.

$R_t$ ceases to become a uniform statistic over a geographical area when case numbers are low, as they have become towards the end of the lock-down. As a result larger regional estimates of $R_t$ become less obviously meaningful, as significant town to town variation will exist as clusters of infection become apparent. This reinforces the point that $R_t$ is a relative measure and should not be interpreted without information about the incidence rate.

# Conclusions

We present a description of the methodology and data sources the University of Exeter has used in providing estimates of $R_t$ in the UK for SPI-M [@NumberGrowthRate]. Whilst we acknowledge the pragmatic nature of those methods, we find that by using a number of data sources and careful interpretation we are able to demonstrate that regional differences in $R_t$ existed from the outset of lock-down  and persisted during lock-down. Due to compound nature of $R_t$ the result of this variation is higher case loads in Northern regions in the UK exiting lock-down. This would tend to suggest a higher risk of secondary outbreaks in those regions.

As we move forward early detection and prevention of spread of emerging clusters SARS-CoV-2 infections is critical to prevent large scale outbreaks. This will be challenging as the long incubation period and high rate of asymptomatic individuals makes undetected rapid spread easy. Prediction at a more localised level is needed to focus both community testing and more targeted
social interventions on high risk areas in the future. 

Critical to this work will be rapid access to information about the spread of SARS-CoV-2 in the community both with high spatial resolution, but also with a short time lag from infection to observation. As test and trace activities ramp up we expect to see similar biases in case related data as testing volumes change locally in response to outbreaks. Our existing approaches to estimating $R_t$ principally use hospital based metrics and as such may not provide the perspective on the outbreak that is needed in the future. Telephone triage data is one potential source of information about local outbreaks, and an area for future investigation [@leclercAnalysisTemporalTrends2020].

# References

<div id="refs"></div>

# Supplementary material

## `r cap$stab("data-source","The combined data sources")`

```{r}
currentRt$rationale %>% select(`Resolution`=codeType, Measure = statistic, `Data source`=sources, `Processing` = processing) %>% group_by(Resolution,Measure) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/TableS1_MethodsDataSources",defaultFontSize = 8)
```

## `r cap$stab("time-delays","Estimated correction of $R_t$ offset based on incubation period and observation delay")`

```{r}
ukcovidtools::ukCovidObservationDelays %>% arrange(mean) %>% select(c(-mean,-sd,-lower,-upper)) %>%
  rename(Observation=to) %>%
  standardPrintOutput::saveTable(filename="~/Dropbox/covid19/current-rt/TableS2_TimeCorrectionsFromIncubationPeriodAndDelayToObservation",defaultFontSize = 8)
```

## `r cap$stab("nhser-rt", "Estimates of mean values of $R_t$ and 95% confidence intervals for the sub-national regions of NHS England, based on 111 calls, cases, deaths and hospital admissions on the 4th July 2020")`

```{r}
r0NHSER %>% filter(date==latestDate) %>% ungroup() %>% select(`NHS Region`=name,`Observation`=source,`R(t) (95% CI)`, `Count per 1M per day (95% CI)`) %>% group_by(`NHS Region`) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/TableS3_NHSRegionRt",defaultFontSize = 8)

```

<!-- # Old -->

<!-- In the accompanying supplementary materials we present an animation of -->
<!-- the $R_t$ over time, and in the rate of change in $R_t$ over time. This -->
<!-- animation raises the possibility of waves of increasing and decreasing -->
<!-- $R_t$ spreading throughout the UK. If such waves can be identified and -->
<!-- predicted we may be able to intercept them in the future, through a -->
<!-- targeted application of community testing and a more localised social -->
<!-- distancing intervention. For this to be an option however we will need -->
<!-- much more granular data on the location of confirmed and suspected -->
<!-- cases, and to as far as possible reduce the time delay between infection -->
<!-- and detection. -->

<!-- In the last part of our analysis we look at the rate of change in $R_t$ -->
<!-- estimated using a simple linear regression. We calculated a regional -->
<!-- estimate of the current rate of change of $R_t$, by fitting a linear -->
<!-- equation to the last 14 points, and extracting the derivative of $R_t$, -->
<!-- associated confidence intervals and measures of goodness of fit. -->


<!-- TODO: These trends of -->
<!-- the differences between the 27th March to the 9th April were further -->
<!-- analysed with a pairwise t-Test and presented in table 3 where we can -->
<!-- see that the $R_t$ differences observed in London, the East, the North -->
<!-- East and North West of England over this time period are statistically -->
<!-- significant. The mean difference in $R_t$ between London and the North -->
<!-- West could be about 0.35, which could have important consequences for -->
<!-- the outbreak progression. -->

<!-- In Figure 2 we plot the absolute difference of $R_t$ in the 7 NHS England -->
<!-- administrative regions, from the $R_t$ of England overall, as a baseline. -->
<!-- This demonstrates the volatility described above and highlights the -->
<!-- regional differences in $R_t$ over time. Prior to the imposition of -->
<!-- social distancing the patterns observed are dominated by noise, as in -->
<!-- the early phase of the outbreak the case numbers in individual regions -->
<!-- were small. However from the 27th March onwards we can see a clearer -->
<!-- trend emerging with the East of England, Midlands, South East and South -->
<!-- Western regions approximately tracking the England baseline. London is -->
<!-- consistently below this baseline and the North West, and less so North -->
<!-- East & Yorkshire are consistently above the baseline. These trends of -->
<!-- the differences between the 27th March to the 9th April were further -->
<!-- analysed with a pairwise t-Test and presented in table 3 where we can -->
<!-- see that the $R_t$ differences observed in London, the East, the North -->
<!-- East and North West of England over this time period are statistically -->
<!-- significant. The mean difference in $R_t$ between London and the North -->
<!-- West could be about 0.35, which could have important consequences for -->
<!-- the outbreak progression. -->

<!-- Due to the fragmented nature of reporting of the outbreak across the 4 -->
<!-- main countries of the UK there is insufficient time series data -->
<!-- available to perform a UK wide regional breakdown of $R_t$. The -->
<!-- availability of time series data is particularly challenging in Northern -->
<!-- Ireland and Wales where we only have a very limited data set. -->

<!-- This introduces -->
<!-- further time delays which may vary in length from individual to -->
<!-- individual. The delay between onset of symptoms and admission has been -->
<!-- estimated at 5 to 9 days [@lintonIncubationPeriodOther2020]. -->
<!-- The delay induced by the test processing is unknown. If we assume a 2 -->
<!-- day delay for testing, we would estimate that interventions begin to -->
<!-- have an effect from 9 days after the intervention, have half of their -->
<!-- impact in 14 days, and begin to have full impact after 22 days. -->

<!-- and is seen in all regions to be decreasing overall. $R_t$ -->
<!-- remains above or equal to 1 at all times and hence within the region of -->
<!-- exponential growth of COVID-19 cases. Over the period from March 19th to -->
<!-- March 25th it is notable that, whilst decreasing in England, the -->
<!-- reproduction number rose in Northern Ireland, Scotland and Wales before -->
<!-- falling again. On the 8th April the $R_t$ was close to one in all regions -->
<!-- apart from England. Two significant dates are marked on the time series. -->
<!-- Firstly, the recommendation for specific social isolation of the -->
<!-- vulnerable on the 16th March, and secondly, the widespread order to -->
<!-- remain at home on the 23rd March. These dates represent the initial and -->
<!-- final dates of implementation of social restrictions. The date of one -->
<!-- serial interval post-lock-down  is also shown. -->

<!-- Over the period from March 19th to -->
<!-- March 25th it is notable that, whilst decreasing in England, the -->
<!-- reproduction number rose in Northern Ireland, Scotland and Wales before -->
<!-- falling again. On the 8th April the $R_t$ was close to one in all regions -->
<!-- apart from England. -->



<!-- The results presented above demonstrate a regional and time based -->
<!-- variation in the reproduction number of SARS-CoV-2. Currently the -->
<!-- reproduction number is close to 1 in most regions and the rate of change -->
<!-- is negative suggesting that we will see a peak to the infection shortly. -->

<!-- the state of the ongoing crisis of -->
<!-- COVID-19 in the UK, but with a sense that the effective reproduction -->
<!-- number is slowly coming under control. The interpretation of the time -->
<!-- series data presented is particularly challenging due to the extensive -->
<!-- time delay in identifying positive cases. As such it is impossible to -->
<!-- conclude whether social distancing is the cause of this improvement. -->

<!-- The current trends in improvement are encouraging and we hope to see -->
<!-- bigger changes in the near future, however we note that this improvement -->
<!-- is not uniformly distributed across the UK and policy makers will have -->
<!-- to be cautious until we can be certain that COVID-19 is under control in -->
<!-- all regions. The difference in apparent $R_t$ between London and the -->
<!-- North Western region of the UK is currently approximately 0.35. Until -->
<!-- that gap has closed it will be difficult to ease the current country -->
<!-- wide restrictions. -->

<!-- ## $R_t$ by Lower Tier Local Authority in England, and Local Health Boards in Wales and Scotland -->

<!-- The following maps provide the most recent (from `r latestDate`) observation of the time varying reproduction number in all the different local authority districts in England, and health boards in Scotland and Wales. Full regional breakdown is not published on a daily basis in Northern Ireland. In panel A and D we see the low confidence interval estimate for $R_t$, in B and E, the median, and in C and F the high confidence interval. In panels G,H and I the relative frequency of the $R_t$ observation for all regions is plotted, a curve to the left of 1 implies the majority of regions implies case numbers are overall decreasing, a curve to the right of one implies case numbers are overall increasing. -->

<!-- ```{r} -->
<!-- data("UKCovidMaps") -->

<!-- # https://github.com/tidyverse/ggplot2/issues/3391 -->
<!-- # some issues joining tibble onto sf - which  -->

<!-- r0shapes = UKCovidMaps$reportingRegionsLTLA %>%  -->
<!--   # fill in missing dates to prevent the map having disappearing / reappearing regions -->
<!--   crossing(tibble(date=unique(r0CombinedUK_LTLA$date))) %>%  -->
<!--   left_join(keyDates, by="date") %>% -->
<!--   left_join( -->
<!--     r0CombinedUK_LTLA, -->
<!--     by=c("code","date"), suffix=c("",".dup")) %>%  -->
<!--   mutate(ago=difftime(date,lubridate::now(),units="days")) %>%  -->
<!--   sf::st_as_sf() -->



<!-- ``` -->

<!-- ```{r} -->
<!-- defaultR0Map = function(data, facet="Median(R)") { -->
<!--   facet = ensym(facet) -->
<!--   return( -->
<!--     ggplot(data)+ -->
<!--     geom_sf(aes(fill=!!facet),size=0.1)+ -->
<!--     scale_fill_gradient2( -->
<!--       low="green", -->
<!--       mid="white", -->
<!--       high="red", -->
<!--       midpoint=0, -->
<!--       trans="log", -->
<!--       #na.value = "black",  -->
<!--       limits=c(0.2,5),  -->
<!--       breaks=c(0.2,0.5,1,2,5),  -->
<!--       labels=c("<0.2","0.5","1","2",">5"), -->
<!--       oob=scales::squish)+ -->
<!--     standardPrintOutput::narrowAndTall()+ -->
<!--     standardPrintOutput::mapTheme() -->
<!--   ) -->
<!-- } -->
<!-- ``` -->

<!-- ```{r fig4, fig.cap="A geographical breakdown of $R_t$ observations in the UK based on cases. Left left column shows lower confidence limits, the central column is the median, and the right column the high confidence limit."} -->
<!-- map1 = defaultR0Map(r0shapes %>% filter(date==latestDate) %>% mutate(`Median(R)` = ifelse(incidence < 2 , NA, `Median(R)`)), `Median(R)`)+guides(fill=guide_colourbar("Observed $R_t$")) -->
<!-- map2 = defaultR0Map(r0shapes %>% filter(date==latestDate) %>% mutate(`Quantile.0.025(R)` = ifelse(incidence < 2 , NA, `Quantile.0.025(R)`)), `Quantile.0.025(R)`)+guides(fill="none") -->
<!-- map3 = defaultR0Map(r0shapes %>% filter(date==latestDate) %>% mutate(`Quantile.0.975(R)` = ifelse(incidence < 2 , NA, `Quantile.0.975(R)`)), `Quantile.0.975(R)`)+guides(fill="none") -->

<!-- map4 = map1 + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75)) -->
<!-- map5 = map2 + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75)) -->
<!-- map6 = map3 + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75)) -->

<!-- map7 = ggplot(r0shapes %>% filter(date==latestDate), aes(x=`Median(R)`))+geom_density()+geom_vline(xintercept = 1,colour="blue")+coord_cartesian(xlim = c(0,2))+xlab("Median")+standardPrintOutput::hideY() -->
<!-- map8 = ggplot(r0shapes %>% filter(date==latestDate), aes(x=`Quantile.0.025(R)`))+geom_density()+geom_vline(xintercept = 1,colour="blue")+coord_cartesian(xlim = c(0,2))+xlab("Low CI")+standardPrintOutput::hideY() -->
<!-- map9 = ggplot(r0shapes %>% filter(date==latestDate), aes(x=`Quantile.0.975(R)`))+geom_density()+geom_vline(xintercept = 1,colour="blue")+coord_cartesian(xlim = c(0,2))+xlab("High CI")+standardPrintOutput::hideY() -->

<!-- out = (map2 + map1 + map3) / (map5+map4+map6) / (map8 + map7 + map9) / patchwork::guide_area() +patchwork::plot_annotation(tag_levels = "A") + patchwork::plot_layout(guides = "collect", heights = c(1,0.36,0.45,0.05))  -->

<!-- out %>% standardPrintOutput::saveFullPageFigure("~/Dropbox/covid19/current-rt/Fig4_Map") -->

<!-- ``` -->


<!-- This analysis covers the last 4 days. There is quite a lot of missing data in recent days. -->

<!-- ```{r fig4, fig.cap="A map of $R_t$ estimates for the Unitary Authority and Local Health Boards of England, Scotland, and Wales"} -->

<!-- listAppend = function(list1,list2) { -->
<!--   list1[[length(list1)+1]] <- list2 -->
<!--   return(list1) -->
<!-- } -->

<!-- plotCols = list() -->
<!-- plotDates = c(latestDate-3,latestDate-2,latestDate-1,latestDate) -->

<!-- ukwide = lapply(plotDates, function(plotDate) { -->
<!--   defaultR0Map(r0shapes %>% filter(date==plotDate))+guides(fill="none")+labs(subtitle = plotDate) -->
<!-- }) -->
<!-- plotCols = ukwide #%>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/lock-down -impact/Fig3_englandMap") -->

<!-- london = lapply(plotDates, function(plotDate) { -->
<!--   defaultR0Map(r0shapes %>% filter(date ==plotDate ))+guides(fill="none")+ coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE) -->
<!-- }) -->
<!-- plotCols = plotCols %>% append(london) -->

<!-- rtDensity = lapply(plotDates, function(plotDate) { -->
<!--   ggplot(r0shapes %>% filter(date==plotDate), aes(x=`Median(R)`))+geom_density()+geom_vline(xintercept = 1,colour="blue")+coord_cartesian(xlim = c(0,3))+ -->
<!--     theme(axis.text.y=element_blank(),axis.title.y=element_blank()) -->
<!-- }) -->
<!-- plotCols = plotCols %>% append(rtDensity) -->

<!-- tmp = patchwork::wrap_plots(plotCols,ncol=4,byrow = TRUE, tag_level = "new")+plot_annotation(tag_levels = "A")  -->
<!-- tmp %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/current-rt/Fig4_Map") -->

<!-- ``` -->



<!-- ### Regions with highest $R_t$ -->

<!-- In the following table the unitary authority areas with the highest median time varying reproduction number are listed, based on case numbers. As some of these areas are quite small there is a good deal of uncertainty in these observations. This list has been restricted to areas which have had more than 200 cases altogether, as areas with very few cases trajectory is heavily influenced by single cases.  As this $R_t$ value is a single observation we expect this to vary significantly from day to day, and these numbers need to be interpreted with caution. -->

<!-- Observations which have a high confidence of being high or low are marked with a double asterisk. The observed time varying reproductive rate ($R_t$) are shown as well as an estimate of the rate of change. An high $R_t$ which is worsening is worth monitoring.  -->

<!-- ```{r} -->

<!-- r0CombinedUK %>% filter(date == latestDate & cumulative_cases>200 & incidence > 2) %>% arrange(desc(`Median(R)`)) %>% head(10) %>% mutate( -->

<!--   `$R_t$ 95% CI` = paste0( tdp(`Median(R)`,`Quantile.0.025(R)`,`Quantile.0.975(R)`), if_else(`Quantile.0.025(R)`>1," **","")), -->
<!--   `Worsening?` = if_else(slope>0,ifelse(`slopeLowerCi`>0,"yes","possibly"),""), -->
<!--   `Delta $R_t$ 95% CI` = paste0(tdp(`slope`,`slopeLowerCi`,`slopeUpperCi`),if_else(`slopeLowerCi`>0," **","")) -->
<!--   ) %>% select(Date = date, Region = name, `$R_t$ 95% CI`, `Worsening?`, `Delta $R_t$ 95% CI`) %>% group_by(Date) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table3_top10Rt", tableWidth = 1, defaultFontSize = 8, colWidths = c(0.7,1.5,1,0.8,1)) -->

<!-- ```  -->

<!-- ### Regions with the fastest increase in $R_t$ -->

<!-- ```{r} -->

<!-- r0CombinedUK %>% filter(date == latestDate & cumulative_cases>200) %>% arrange(desc(slope)) %>% head(10) %>% mutate( -->
<!--   `$R_t$ 95% CI` = paste0( tdp(`Median(R)`,`Quantile.0.025(R)`,`Quantile.0.975(R)`), if_else(`Quantile.0.025(R)`>1," **","")), -->
<!--   `Increasing?` = if_else(`Median(R)`>1,ifelse(`Quantile.0.025(R)`>1,"yes","possibly"),""), -->
<!--   `Delta $R_t$ 95% CI` = paste0(tdp(`slope`,`slopeLowerCi`,`slopeUpperCi`),if_else(`slopeLowerCi`>0," **","")) -->
<!--   ) %>% select(Date = date, Region = name, `$R_t$ 95% CI`, `Increasing?`, `Delta $R_t$ 95% CI`) %>% group_by(Date) %>%  -->
<!--   standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table4_top10DeltaRt", tableWidth = 1, defaultFontSize = 8, colWidths = c(0.7,1.5,1,0.8,1)) -->

<!-- ```  -->

<!-- ### Regions with lowest $R_t$ -->

<!-- In the following table the unitary authority areas with the lowest median time varying reproduction number are listed, based on case numbers. As above this list has been restricted to areas which have had more than 200 cases altogether.  -->

<!-- Observations which have a high confidence of being high or low are marked with a double asterisk. The observed time varying reproductive rate ($R_t$) are shown as well as an estimate of the rate of change. A low $R_t$ which continues to improve (which includes the majority of this table) is reassuring.  -->

<!-- ```{r} -->

<!-- r0CombinedUK %>% filter(date == latestDate & cumulative_cases>200 & incidence > 2) %>% arrange(`Median(R)`) %>% head(10) %>% mutate( -->
<!--   `$R_t$ 95% CI` = paste0( tdp(`Median(R)`,`Quantile.0.025(R)`,`Quantile.0.975(R)`), if_else(`Quantile.0.975(R)`<1," **","")), -->
<!--   `Improving?` = if_else(slope<0,ifelse(`slopeUpperCi`<0,"yes","possibly"),""), -->
<!--   `Delta $R_t$ 95% CI` = paste0(tdp(`slope`,`slopeLowerCi`,`slopeUpperCi`),if_else(`slopeUpperCi`<0," **","")) -->
<!--   ) %>% select(Date = date, Region = name, `$R_t$ 95% CI`, `Improving?`, `Delta $R_t$ 95% CI`) %>% group_by(Date) %>%  -->
<!--   standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table5_bottom10Rt", tableWidth = 1, defaultFontSize = 8, colWidths = c(0.7,1.5,1,0.8,1)) -->

<!-- ```  -->

<!-- ### Regions with the fastest decrease in $R_t$ -->

<!-- ```{r} -->

<!-- r0CombinedUK %>% filter(date == latestDate & cumulative_cases>200) %>% arrange(slope) %>% head(10) %>% mutate( -->
<!--   `$R_t$ 95% CI` = paste0( tdp(`Median(R)`,`Quantile.0.025(R)`,`Quantile.0.975(R)`), if_else(`Quantile.0.975(R)`<1," **","")), -->
<!--   `Decreasing?` = if_else(`Median(R)`<1,ifelse(`Quantile.0.975(R)`<1,"yes","possibly"),""), -->
<!--   `Delta $R_t$ 95% CI` = paste0(tdp(`slope`,`slopeLowerCi`,`slopeUpperCi`),if_else(`slopeUpperCi`<0," **","")) -->
<!--   ) %>% select(Date = date, Region = name, `$R_t$ 95% CI`, `Decreasing?`, `Delta $R_t$ 95% CI`) %>% group_by(Date) %>%  -->
<!--   standardPrintOutput::saveTable("~/Dropbox/covid19/current-rt/Table3_bottom10DeltaRt", tableWidth = 1, defaultFontSize = 8, colWidths = c(0.7,1.5,1,0.8,1)) -->

<!-- ```  -->
<!-- In figures 3 and 4 we present the detailed regional breakdown of -->
<!-- reproduction number in the 149 unitary authorities in England. These are -->
<!-- illustrated at time points representing the start of the 2 social -->
<!-- distancing measures implemented by the UK government and described -->
<!-- above, and marked on figures 1 and 2. In the individual unitary -->
<!-- authority regions case numbers may be quite small so the estimates of -->
<!-- $R_t$ may have wide confidence intervals which are not shown. The full -->
<!-- regional breakdown including confidence intervals is available as -->
<!-- supplementary materials. In the vast majority of regions and time points -->
<!-- the reproduction number is greater than 1, but the same decreasing trend -->
<!-- is present. -->

<!-- ```{r} -->
<!-- data("UKCovidMaps") -->

<!-- # https://github.com/tidyverse/ggplot2/issues/3391 -->
<!-- # some issues joining tibble onto sf - which  -->

<!-- r0shapes = UKCovidMaps$reportingRegions %>%  -->
<!--   # fill in missing dates to prevent the map having disappearing / reappearing regions -->
<!--   crossing(tibble(date=unique(ts$r0CombinedUK$date))) %>%  -->
<!--   left_join(keyDates, by="date") %>% -->
<!--   left_join( -->
<!--     ts$r0CombinedUK, -->
<!--     by=c("code","date"), suffix=c("",".dup")) %>%  -->
<!--   mutate(ago=difftime(date,lubridate::now(),units="days")) %>%  -->
<!--   sf::st_as_sf() -->

<!-- defaultR0Map = function(data) { -->
<!--   return( -->
<!--     ggplot(data)+ -->
<!--     geom_sf(aes(fill=`Median(R)`))+ -->
<!--     scale_fill_gradient2( -->
<!--       low="green", -->
<!--       mid="white", -->
<!--       high="red", -->
<!--       midpoint=0, -->
<!--       trans="log", -->
<!--       na.value = "grey80",  -->
<!--       limits=c(0.2,5),  -->
<!--       breaks=c(0.2,0.5,1,2,5),  -->
<!--       labels=c("<0.2","0.5","1","2",">5"), -->
<!--       oob=scales::squish)+ -->
<!--     standardPrintOutput::narrowAndTall()+ -->
<!--     standardPrintOutput::mapTheme() -->
<!--   ) -->
<!-- } -->

<!-- defaultDeltaR0Map = function(data) { -->
<!--   return( -->
<!--     ggplot(data)+ -->
<!--     geom_sf(aes(fill=slope))+ -->
<!--     scale_fill_gradient2( -->
<!--       low="cyan", -->
<!--       mid="white", -->
<!--       high="magenta", -->
<!--       midpoint=0, -->
<!--       na.value = "grey80", -->
<!--       limits=c(-0.5,0.5),  -->
<!--       breaks=c(-0.5,-0.25,0,0.25,0.5),  -->
<!--       labels=c("<-0.5","-0.25","0","0.25",">0.5"), -->
<!--       oob=scales::squish)+ -->
<!--     standardPrintOutput::narrowAndTall()+ -->
<!--     standardPrintOutput::mapTheme() -->
<!--   ) -->
<!-- } -->
<!-- ``` -->

<!-- *Figure 3 - the median value of $R_t$ at the time of announcement of -->
<!-- different social interventions designed to prevent spread of SARS-CoV-2, -->
<!-- by England* *Unitary Authority regions. Not all regions provided time -->
<!-- regional series data over the period under investigation and these areas -->
<!-- are represented in grey.* -->

<!-- ```{r} -->
<!-- ukwide =  -->
<!--   defaultR0Map(r0shapes %>% filter(!is.na(label)))+ -->
<!--   facet_wrap(vars(label), nrow = 1) -->
<!-- ukwide %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/regional-infectivity/Fig3_englandMap") -->

<!-- ``` -->
<!-- *Figure 4 - the median value of $R_t$ at the time of announcement of -->
<!-- different social interventions designed to prevent spread of SARS-CoV-2, -->
<!-- by England Unitary Authority region in London* -->

<!-- ```{r} -->
<!-- london = ukwide + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE) + standardPrintOutput::mapTheme() -->
<!-- london %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/regional-infectivity/Fig4_londonMap") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- # birmingham = ukwide + coord_sf(crs = 4326,xlim = c(-2.3, -1.5), ylim = c(52.25, 52.75), expand = FALSE) + standardPrintOutput::mapTheme() -->
<!-- # birmingham %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/regional-infectivity/Fig4_birminghamMap") -->
<!-- ``` -->
<!-- In figure 5 we present the regional analysis of the current rate of -->
<!-- change of $R_t$. This aims to demonstrate the magnitude in change of $R_t$ -->
<!-- over time and hence give us a sense of whether social distancing -->
<!-- measures are currently having the desired effect of reducing the overall -->
<!-- velocity of infection. In this time series, if the rate of change of -->
<!-- $R_t$ is positive, the infection is accelerating. Negative values, on the -->
<!-- other hand, represent deceleration. We can see that in England, the -->
<!-- viral infection has been decelerating from before the onset of the full -->
<!-- social distancing policies of the 23rd March. In the other regions of -->
<!-- the UK on the other hand we see a continued acceleration of the viral -->
<!-- spread until approximately one serial interval after the 23rd March -->
<!-- after which the infection begins to decelerate. -->


<!-- *Figure 5 - the rate of change of $R_t$ per day in different regions of -->
<!-- the UK.* -->

<!-- In figures 6 and 7 we present a more detailed regional analysis of the -->
<!-- rate of change of $R_t$ by Unitary Authority in England or Local Health -->
<!-- Board in Scotland and Wales. We do not have complete data for this -->
<!-- regional breakdown in Wales, but in the far right panel representing the -->
<!-- most up to date time point, we see that in the vast majority of areas in -->
<!-- England the rate of change is negative (cyan) representing a continued -->
<!-- day on day fall in transmission. However there is seen to be regional -->
<!-- variation in the preceding days and weeks, and that the widespread -->
<!-- negative rate of change of $R_t$ is a relatively recent feature. -->


<!-- *Figure 6 - the median value of $R_t$ at the time of announcement of -->
<!-- different social interventions designed to prevent spread of SARS-CoV-2, -->
<!-- by England Unitary Authority regions (England), and Local Health Boards -->
<!-- (Scotland and Wales). Not all regions provided time regional series data -->
<!-- over the period under investigation and these areas are represented in -->
<!-- grey.* -->



<!-- ```{r} -->
<!-- ukwideDelta =  -->
<!--   defaultDeltaR0Map(r0shapes %>% filter(!is.na(label)))+ -->
<!--   facet_wrap(vars(label), nrow = 1) -->
<!-- ukwideDelta %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/regional-infectivity/Fig6_englandMapDelta") -->
<!-- ``` -->

<!-- *Figure 7 - the median value of $R_t$ at -->
<!-- the time of announcement of different social interventions designed to -->
<!-- prevent spread of SARS-CoV-2, by England Unitary Authority region in -->
<!-- London* -->

<!-- ```{r} -->
<!-- londonDelta = ukwideDelta + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE) + standardPrintOutput::mapTheme() -->
<!-- londonDelta %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/regional-infectivity/Fig7_londonMapDelta") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- # birminghamDelta = ukwideDelta + coord_sf(crs = 4326,xlim = c(-2.3, -1.5), ylim = c(52.25, 52.75), expand = FALSE) + standardPrintOutput::mapTheme() -->
<!-- # birminghamDelta %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/regional-infectivity/Fig7_birminghamMapDelta") -->
<!-- ``` -->


<!-- ## Create and save animated map -->

<!-- Animated maps are viewable: -->

<!-- * https://github.com/terminological/uk-covid-datatools/blob/master/vignettes/UK_Rt_over_time.gif -->

<!-- ```{r eval=FALSE} -->
<!-- dates = tibble(date1=as.Date(min(r0shapes$date):max(r0shapes$date),origin=as.Date("1970-01-01"))) -->
<!-- barAnim = ggplot(dates,aes(xmax=date1+1,xmin=date1))+ -->
<!--   geom_rect(ymin=0,ymax=1) +  -->
<!--   ylim(c(0,1))+ -->
<!--   geom_vline(aes(xintercept=date,colour=event),data=keyDates,size=4,show.legend = FALSE)+ -->
<!--   # ggrepel::geom_text_repel( -->
<!--   #   aes(x=date, y=1.25, colour=event, label=event),data=keyDates, hjust=0.5,vjust=0, show.legend = FALSE,box.padding=0.05,inherit.aes = FALSE, -->
<!--   #         size=(10/ggplot2:::.pt/(96/72)))+ -->
<!--   theme( -->
<!--     axis.text.y = element_blank(), -->
<!--     axis.ticks.y = element_blank(),  -->
<!--     panel.grid.major.y = element_blank(),  -->
<!--     panel.grid.minor.y = element_blank(),  -->
<!--     axis.title.x = element_blank() -->
<!--   )+ -->
<!--   coord_cartesian(ylim = c(0, 1), clip = 'off')+ -->
<!--   gganimate::transition_time(date1) -->

<!-- timeGif = gganimate::animate(barAnim, renderer=gganimate::magick_renderer(), width=800, height=60, nframes=200) -->


<!-- ukwideAnim =  -->
<!--   defaultR0Map(r0shapes)+ -->
<!--   guides(fill="none")+labs(subtitle="A")+ -->
<!--   gganimate::transition_time(date) -->

<!-- londonAnim =  -->
<!--   defaultR0Map(r0shapes)+ -->
<!--   coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE) +  -->
<!--   standardPrintOutput::mapTheme()+labs(subtitle="C")+ -->
<!--   gganimate::transition_time(date) -->

<!-- ukwideDeltaAnim =  -->
<!--   defaultDeltaR0Map(r0shapes)+ -->
<!--   guides(fill="none")+labs(subtitle="B")+ -->
<!--   gganimate::transition_time(date) -->

<!-- londonDeltaAnim =  -->
<!--   defaultDeltaR0Map(r0shapes)+ -->
<!--   coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE) +  -->
<!--   standardPrintOutput::mapTheme()+labs(subtitle="D")+ -->
<!--   gganimate::transition_time(date) -->

<!-- ukWideGif = gganimate::animate(ukwideAnim, renderer=gganimate::magick_renderer(), width=400, height=800, nframes=200) -->
<!-- londonGif = gganimate::animate(londonAnim, renderer=gganimate::magick_renderer(), width=400,height=300, nframes=200) -->
<!-- ukWideDeltaGif = gganimate::animate(ukwideDeltaAnim, renderer=gganimate::magick_renderer(), width=400, height=800, nframes=200) -->
<!-- londonDeltaGif = gganimate::animate(londonDeltaAnim, renderer=gganimate::magick_renderer(), width=400,height=300, nframes=200) -->

<!-- captionTif = magick::image_read(path = "~/Git/uk-covid-datatools/vignettes/suppFig1Caption.png") -->

<!-- layoutGifs = function(i) { -->
<!--   magick::image_append(c( -->
<!--   magick::image_append(c(ukWideGif[i], ukWideDeltaGif[i])), -->
<!--   magick::image_append(c(londonGif[i], londonDeltaGif[i])), -->
<!--   timeGif[i], captionTif[1]), stack=TRUE) -->
<!-- } -->

<!-- new_gif <- layoutGifs(1) -->
<!-- for(i in 2:200){ -->
<!--   combined <- layoutGifs(i) -->
<!--   new_gif <- c(new_gif, combined) -->
<!-- } -->

<!-- #gganimate::anim_save("~/Git/uk-covid-datatools/vignettes/UK_Rt_over_time.gif",new_gif) -->
<!-- magick::image_write_gif(new_gif,path="~/Git/uk-covid-datatools/vignettes/UK_Rt_over_time.gif") -->
<!-- # ggplot(r0shapes, aes(x=date,y=`Median(R)`,colour=code))+geom_line(alpha=0.2,show.legend = FALSE) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- UKCovidNeghbours = UKCovidMaps$reportingRegions %>% createNeighbourNetwork(code) -->
<!-- write.csv(UKCovidNeghbours,"~/Git/uk-covid-datatools/vignettes/Rt_Timeseries_Neighbours.csv") -->

<!-- ``` -->

<!-- ```{r} -->

<!-- # captionTif = magick::image_read(path = "~/Git/uk-covid-datatools/vignettes/suppFig1Caption.png") -->
<!-- # manGif = magick::image_read(path = "~/Dropbox/covid19/regional-infectivity/eurosurveillanceSubmission/UK_Rt_over_time_no_label.gif") -->
<!-- #  -->
<!-- # new_gif <- magick::image_append(c(manGif[1], captionTif[1]), stack=TRUE) -->
<!-- # for(i in 2:100){ -->
<!-- #   combined <- magick::image_append(c(manGif[i], captionTif[1]), stack=TRUE) -->
<!-- #   new_gif <- c(new_gif, combined) -->
<!-- # } -->
<!-- #  -->
<!-- # magick::image_write_gif(new_gif,path="~/Git/uk-covid-datatools/vignettes/UK_Rt_over_time_2.gif") -->


<!-- # rateOfChangeDist = ggplot(rateOfChange, aes(x=slope))+geom_density()+geom_rug()+geom_vline(xintercept = 0, colour="blue")+coord_cartesian(xlim=c(-0.5,0.5)) -->
<!-- #  -->
<!-- # ukRateOfChange = ggplot(rateOfChangeUKregion, aes(x=uk_region,y=slope,fill=slope))+ -->
<!-- #   scale_fill_gradient2( -->
<!-- #     low="cyan", -->
<!-- #     mid="white", -->
<!-- #     high="magenta", -->
<!-- #     midpoint=0, -->
<!-- #     #trans="log", -->
<!-- #     na.value = "grey80", -->
<!-- #     limits=c(-1,1),  -->
<!-- #     breaks=c(-1,-0.5,0,0.5,1),  -->
<!-- #     labels=c("<-1","-0.5","0","0.5",">1") -->
<!-- #     ) +  -->
<!-- #   geom_bar(stat="identity", colour="black")+geom_errorbar(aes(ymin=slopeLowerCi,ymax=slopeUpperCi), width=0.2) -->
<!-- #  -->
<!-- # (ukwideRateOfChange + londonRateofChange  + ukRateOfChange + rateOfChangeDist + plot_annotation(tag_levels = 'A')  + plot_layout(nrow = 2, guides="collect")) %>% standardPrintOutput::saveHalfPageFigure("~/Dropbox/covid19/regional-infectivity/Fig4_RateOfChangeMap") -->
<!-- #  -->

<!-- ``` -->

<!-- ```{r} -->

<!-- # rateOfChange %>% ungroup() %>% filter(slopeLowerCi > 0) %>% arrange(desc(slope)) %>% head(5) %>% mutate(`95% CI` = sprintf("%1.2f; %1.2f",slopeLowerCi,slopeUpperCi)) %>% select(`Unitary authority`=name,`dR/dt`=slope, `95% CI` ,`R^2`=r_squared) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/regional-infectivity/Table2_Top5UnitaryAuthoritiesByDeltaR_t") -->

<!-- ``` -->

<!-- ```{r} -->

<!-- # rateOfChange %>% ungroup() %>% filter(slopeUpperCi < 0) %>% arrange(slope) %>% head(5) %>% mutate(`95% CI` = sprintf("%1.2f; %1.2f",slopeLowerCi,slopeUpperCi)) %>% select(`Unitary authority`=name,`dR/dt`=slope, `95% CI` ,`R^2`=r_squared) %>% standardPrintOutput::saveTable("~/Dropbox/covid19/regional-infectivity/Table3_Bottom5UnitaryAuthoritiesByDeltaR_t") -->

<!-- ``` -->




<!-- ```{r} -->

<!-- # tmpDeltaR0timeseries =  -->
<!-- #  -->
<!-- # rateOfChangeShapes = UKCovidMaps$reportingRegions %>% -->
<!-- #   crossing(tibble(date=unique(tmpDeltaR0timeseries$date))) %>%  -->
<!-- #   left_join(tmpDeltaR0timeseries, by=c("code","date")) %>% -->
<!-- #   sf::st_as_sf()  -->
<!-- #  -->
<!-- # ukwideRateOfChange = ggplot(rateOfChangeShapes)+ -->
<!-- #   geom_sf(aes(fill=slope))+ -->
<!-- #   scale_fill_gradient2( -->
<!-- #     low="cyan", -->
<!-- #     mid="white", -->
<!-- #     high="magenta", -->
<!-- #     midpoint=0, -->
<!-- #     trans="pseudo_log", -->
<!-- #     na.value = "grey80", -->
<!-- #     limits=c(-1,1),  -->
<!-- #      -->
<!-- #     breaks=c(-1,-0.5,0,0.5,1),  -->
<!-- #     labels=c("<-1","-0.5","0","0.5",">1") -->
<!-- #     )+ -->
<!-- #   standardPrintOutput::mapTheme() -->
<!-- #  -->
<!-- # anim5 = ukwideRateOfChange + guides(fill="none")+#labs(title = 'Date: {frame_time}')+ -->
<!-- #   gganimate::transition_time(date) -->
<!-- # gif5 = gganimate::animate(anim5, renderer=gganimate::magick_renderer(), width=400, height=800) -->
<!-- #  -->
<!-- # anim6 = ukwideRateOfChange + coord_sf(crs = 4326,xlim = c(-0.7, 0.5), ylim = c(51.25, 51.75), expand = FALSE)+ -->
<!-- #   gganimate::transition_time(date) -->
<!-- # gif6 = gganimate::animate(anim6, renderer=gganimate::magick_renderer(), duration = 10, fps=10, width=400, height=300) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- # dates = tibble(date1=as.Date(min(rateOfChangeShapes$date):max(rateOfChangeShapes$date),origin=as.Date("1970-01-01"))) -->
<!-- # barAnim = ggplot(dates,aes(xmax=date1+1,xmin=date1))+ -->
<!-- #   geom_rect(ymin=0,ymax=1) +  -->
<!-- #   ylim(c(0,1))+ -->
<!-- #   geom_vline(aes(xintercept=date,colour=event),data=keyDates,size=4,show.legend = FALSE)+ -->
<!-- #   # ggrepel::geom_text_repel( -->
<!-- #   #   aes(x=date, y=1.25, colour=event, label=event),data=keyDates, hjust=0.5,vjust=0, show.legend = FALSE,box.padding=0.05,inherit.aes = FALSE, -->
<!-- #   #         size=(10/ggplot2:::.pt/(96/72)))+ -->
<!-- #   theme( -->
<!-- #     axis.text.y = element_blank(), -->
<!-- #     axis.ticks.y = element_blank(),  -->
<!-- #     panel.grid.major.y = element_blank(),  -->
<!-- #     panel.grid.minor.y = element_blank(),  -->
<!-- #     axis.title.x = element_blank() -->
<!-- #   )+ -->
<!-- #   coord_cartesian(ylim = c(0, 1), clip = 'off')+ -->
<!-- #   gganimate::transition_time(date1) -->
<!-- #  -->
<!-- # timeGif = gganimate::animate(barAnim, renderer=gganimate::magick_renderer(), width=800, height=60) -->
<!-- ``` -->

<!-- ```{r eval=FALSE} -->



<!-- # ukRateOfChange = ggplot(deltaR0Regionaltimeseries, aes(x=uk_region,y=slope,fill=slope))+ -->
<!-- #   scale_fill_gradient2( -->
<!-- #     low="cyan", -->
<!-- #     mid="white", -->
<!-- #     high="magenta", -->
<!-- #     midpoint=0, -->
<!-- #     #trans="log", -->
<!-- #     na.value = "grey80", -->
<!-- #     limits=c(-0.5,0.5),  -->
<!-- #     breaks=c(-0.5,-0.25,0,0.25,0.5),  -->
<!-- #     labels=c("<-0.5","-0.25","0","0.25",">0.5") -->
<!-- #     ) + geom_bar(stat="identity", colour="black")+geom_errorbar(aes(ymin=slopeLowerCi,ymax=slopeUpperCi), width=0.2)+ -->
<!-- #   coord_cartesian(ylim=c(-0.25,0.25))#+ -->
<!-- #   #labs(title = 'Date: {frame_time}') -->
<!-- #  -->
<!-- # anim3 = ukRateOfChange+gganimate::transition_time(date) -->
<!-- # gif3 = gganimate::animate(anim3, renderer=gganimate::magick_renderer(), width=400, height = 300) -->
<!-- # #gganimate::anim_save("~/Git/uk-covid-datatools/vignettes/delta_Rt_by_uk_region_over_time.gif",gif) -->
<!-- #  -->
<!-- # rateOfChangeDist = ggplot(deltaR0timeseries %>% filter(!is.na(slope)), aes(x=slope))+geom_density()+geom_rug()+geom_vline(xintercept = 0, colour="blue")+coord_cartesian(xlim=c(-0.5,0.5))+labs(title = " ") -->
<!-- # anim4 = rateOfChangeDist+gganimate::transition_time(date) -->
<!-- # gif4 = gganimate::animate(anim4, renderer=gganimate::magick_renderer(), width=400, height = 200) -->
<!-- #  -->
<!-- # new_gif <- magick::image_append(c( -->
<!-- #       magick::image_append(c( -->
<!-- #         gif5[1], -->
<!-- #         magick::image_append(c( -->
<!-- #           gif3[1],  -->
<!-- #           gif4[1], -->
<!-- #           gif6[1] -->
<!-- #         ),stack=TRUE) -->
<!-- #       )), -->
<!-- #       timeGif[1] -->
<!-- # ),stack=TRUE)  -->
<!-- # for(i in 2:100){ -->
<!-- #   combined <- magick::image_append(c( -->
<!-- #       magick::image_append(c( -->
<!-- #         gif5[i], -->
<!-- #         magick::image_append(c( -->
<!-- #           gif3[i],  -->
<!-- #           gif4[i], -->
<!-- #           gif6[i] -->
<!-- #         ),stack=TRUE) -->
<!-- #       )), -->
<!-- #       timeGif[i] -->
<!-- # ),stack=TRUE) -->
<!-- #      -->
<!-- #   new_gif <- c(new_gif, combined) -->
<!-- # } -->
<!-- #  -->
<!-- # magick::image_write_gif(new_gif,path="~/Git/uk-covid-datatools/vignettes/delta_Rt_over_time.gif") -->
<!-- #gganimate::anim_save("~/Git/uk-covid-datatools/vignettes/delta_Rt_over_time.gif",new_gif) -->
<!-- #gganimate::anim_save("~/Git/uk-covid-datatools/vignettes/delta_Rt_distribution_over_time.gif",gif) -->
<!-- ``` -->


<!-- ``` -->


